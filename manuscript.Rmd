---
title: plantecophys - an R package for analysis and modelling of leaf gas exchange data
author: ''
date: ''
output:
  word_document:
    reference_docx: manuscriptstyle.docx
  pdf_document: default
  html_document:
    number_sections: yes
csl: plos-one.csl
bibliography: references.bib
---

\
Remko A. Duursma^1^

\
^1^ Hawkesbury Institute for the Environment, University of Western Sydney, Locked Bag 1797, Penrith, NSW, Australia

\
*Corresponding author*: 
Remko Duursma
E: remkoduursma@gmail.com
T: +61(0)422096908

<!---
For Submission to PLOS one
e.g. http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0061217
http://journals.plos.org/ploscollections/article?id=10.1371/journal.pcbi.1003929
http://journals.plos.org/ploscollections/article?id=10.1371/journal.pcbi.1003270
and see: http://journals.plos.org/plosone/s/submission-guidelines
(Methods, software, databases, and tools)
--->


```{r echo=FALSE, message=FALSE}
# Two useful packages for printing numbers, accessing content of objects.
library(broom)
library(reporttools)

# mine
library(plantecophys)

# figures
source("figures.R")

# Do calculations here, create objects that we can use throughout the paper.

# Or, place them all in a separate script:
# source("manuscript_calcs.R")

# Shorthand function to print numbers with two decimal points (and retain trailing zeroes)
f <- function(x, digits=2)sprintf(x, fmt=paste0("%.",digits,"f"))

# Nice function to format P values.
pval <- function(...)formatPval(..., includeEquality=TRUE)

# Set Flag to include figures in text or not.
includeFigs <- TRUE

# This document can be compiled with the 'Knit Word' button in Rstudio, or:
# library(rmarkdown)
# render("manuscript.Rmd", "word_document", "manuscript.docx")
```




# Abstract {.unnumbered}

Here I present the R package 'plantecophys', a toolkit to analyse and model leaf gas exchange data, a cornerstone of plant ecophysiological research. Measurements of leaf photosynthesis and transpiration are routinely collected with portable gas exchange instruments, and analyzed with a few key models. These models include the Farquhar-von Caemmerer-Berry model of leaf photosynthesis, the Ball-Berry models of stomatal conductance, and the coupled leaf gas exchange model which combines the supply and demand functions for CO2 in the leaf. The 'plantecophys' R package includes functions both for fitting these models to measurements, as well as simulating from the fitted models to aid in interpreting experimental data. Here I describe the functionality and implementation of the new package, and give examples on its use in plant ecophysiological research. The package makes technically challenging calculations easily accessible for many users. I briefly describe functions for modelling C3 leaf gas exchange with the coupled photosynthesis-stomatal conductance model, fitting of the Farquhar model of photosynthesis to measurements of photosynthesis-CO~2~ response curves ('A-Ci curves'), modelling C4 photosynthesis, numerical solution of optimal stomatal behaviour, and energy balance calculations using the Penman-Monteith equation. The package is freely available on CRAN, and a development version is hosted at http://www.bitbucket.org/remkoduursma/plantecophys.




# Introduction

Wealth of leaf gas exchange data collected in the field of plant ecological physiology. Especially since the advent of portable, easy to use, gas exchange instruments such as the Licor-6400.

These data are used to estimate important plant traits such as Vcmax&Jmax, as well to study responses of stomatal conductance to key environmental drivers.

The photosynthesis model of Farquhar, von Caemmerer and Berry [@farquhar1980] (the 'FvC model') is very widely used in interpreting leaf gas exchange data (cites), up to predicting carbon uptake by vegetation at a global scale. The key prediction of the model is the response of photosynthesis to [CO~2~] in the intercellular airspaces (Ci). In turn, Ci is controlled the result of the balance between diffusion of CO2 through the stomata, and the uptake of CO2 by photosynthesis. To employ the model, it is generally fit to observations of net photosynthesis along a range of [CO2] concentrations. 

Various methods exist to fit the model to data, which requires some finesse because the model is not a single non-linear equation, but instead a minimum function that is sometimes difficult to fit (Gu), and sample sizes collected are often small due to time constraints in the field. We do not repeat a description of the Farquhar model here, it has been described many times. But generally it is of the form,

(1)
$$A_n = min(A_c, A_j) - R_d$$

where A~c~ is the gross photosynthesis rate when Rubisco activity is limiting, A~j~ when RuBP-regeneration is limiting, and R~d~ the rate of dark respiration. A~c~ and A~j~ are non-linear functions of the intercellular CO~2~ concentration (C~i~), both of the form $k_1(C_i\Gamma^∗)/(k_2 + C_i)$, where $\Gamma^∗$ is the CO~2~ compensation point without R~d~, and k~1~ and k~2~ are different parameter combinations for A~c~ and A~j~. The details of these functions and the temperature dependence of the parameters are described elsewhere (e.g. Medlyn et al., 2002).
As mentioned above, the parameters Vcmax and Jmax that are embedded in Eq. 1 are not easy to estimate, moreover because the various dependencies of the parameters on leaf temperature must be accounted for.

Once the A-Ci curve is fitted, we can use the Farquhar (FvC) model to simulate the relationship between substrate availability (for which Ci is as a proxy) and rates of photosynthetic CO2 assimilation. 

(2)
$$ A_n = g_s(C_a - C_i) $$

We now have two equations for the photosynthesis rate. The demand-based one (Eq. 1) and the diffusion-based one. At steady state these two should be equal, which can be graphically shown as in Fig. 1 (cf. [@farquhar1982]). 

The next step is to include a model of g~s~ that allows for the known response of g~s~ to drivers including vapour pressure deficit and atmospheric CO~2~ concentration (C~a~). The most successful, though empirical, suite of gs models is the Ball-Berry class of models where gs is modelled as a function of A~n~ and D and CO2. This way, effects of leaf temperature and PPFD - both of which are known to affect gs - are modelled through the dependency of photosynthesis on these drivers. Thus the third equation is,

(3)
$$ g_s = g_0 + g_1 \frac{A_n}{C_a}f(D)$$

Through Eqs. 1-3 we now have the coupled leaf gas exchange model, which allows modelling of A, g_s and leaf transpiration rate in response to all major environmental drivers (except soil water limitation), and key leaf traits (g1, Vcmax, Jmax, Rd). This coupled leaf gas exchange model can be solved as a quadratic equation, yielding the setpoint C~i~ (Fig. 1), and has found use in many applications (cite). In the next section we describe the various options for f(D) as well as an independent approach assuming that stomatal conductance is optimized to maximize photosynthesis at a given water expenditure (cf. Cowan, Medlyn).

Despite the widespread use of a standard instrument to collect data, tools to analyze the data are scattered and subject to little standardization. Some excel sheets here and there, etc., but we need a solid set of tools in the widely used R language. I here describe the plantecophys package, implemented in the R language.

We have used the code in several of our papers, including [@medlyn2011; @duursma2013; @duursma2014].


# Design and implementation

## The main functions

The main functions in the package include functions to : 

- Fit, summarize, plot and simulate photosynthesis-[CO~2~] response curves (known as 'A-Ci' curves)
- Fit Ball-Berry type models of stomatal conductance
- Estimate optimal stomatal conductance with a numerical implementation of the Cowan-Farquhar hypothesis
- Simulate leaf photosynthesis and transpiration with the coupled leaf gas exchange model
- Estimate leaf temperature from energy balance, when a significant leaf boundary layer is present
- Convert between commonly used units (relative humidity, vapour pressure deficit, dewpoint temperature).


## Language

The 'plantecophys' package is implemented in native R, and has no dependencies on other packages. As such it compiles easily, and is highly portable. The source code is maintained with git version control, and is hosted in an online repository (http://www.bitbucket.org/remkoduursma/plantecophys). The repository includes an issue tracker, where users can suggest changes or report bugs.



## Results


### Fitting A-Ci curves

We have implemented `fitaci`, which fits the FvC model in two different ways. A widely used published method requires the user to specify the transition of Vcmax to Jmax limitation [@sharkey2007], a process that both prevents batch analysis and is arbitrary. Another method (http://leafweb.ornl.gov/) requires online submission of data and fits the model without much control or knowledge of the fitting process [@gu2010]. Undoubtedly many more implementations of the fitting process have been developed over the years, but few of these are made publicly available (but see e.g. https://github.com/mdekauwe/FitFarquharModel). 

Details about it : fits the hyperbolic min function simultaneously. Retrieves estimates of Vcmax, Jmax and Rd (the latter can also be held constant at a known value, in which case only Jmax and Vcmax are fit). Optionally can specify the transition point, so that the Vcmax-limited part is fit independent of the Jmax-limited part. Returns parameter estimates and standard errors, and includes a plot method. Fig 2. is made like this:


```
f <- fitaci(mydata)
plot(f)
```

The function `Aci` simulates the A-Ci curve.

### Fitting stomatal conductance models

Implementation of several stomatal conductance models, including [@ballberry1987; @leuning1995; @medlyn2011].


### Coupled leaf gas exchange model

The intersection of the supply and demand curves of photosynthesis gives the operating intercellular CO~2~ concentration. This is solved by the `Photosyn` function. 


### Numerical solution of optimal stomatal conductance

Full numerical optimization of the Cowan-Farquhar hypothesis. We have used this code in [@medlyn2011], and is very similar to that used by [@buckley2014].


# Conclusions

We need a publicly available, open source, set of tools to analyze these data which form the cornerstone of plant physiological ecology. Though alternative methods exist to fit A-Ci curves and other details of the implementations can see alternatives, the plantecophys package provides a platform where such methods comparisons can be made. The R language is now widely used, and many users can make changes to the code and recompile the package. 
We have included a set of functions that are key to ecophysiological research. There is certainly scope, and interest, to increase the array of tools included in the package. 




# Availability and requirements

**Project name**: plantecophys

**Project Stable Release**: cran.r-project.org/package=plantecophys

**Project Home Page**: http://www.bitbucket.org/remkoduursma/plantecophys

**Project Issue Tracker**: http://www.bitbucket.org/remkoduursma/plantecophys/issues

**Operating System(s)**: Platform Independent

**Programming Language(s)**: R

**Other Requirements**: none



# Acknowledgements {.unnumbered}
Thanks to John Drake for extensive testing. David Ellsworth, Belinda Medlyn, Martin de Kauwe are acknowledged for discussion on fitting A-Ci curves. Special thanks to Belinda Medlyn whose code in the MAESTRA model provided inspiration for an early version of the Photosyn function. 




# Figures {.unnumbered}


```{r fig.width=6, fig.height=6, echo=FALSE, message=FALSE, eval=includeFigs, warn=FALSE}
figure1()
```
** Figure 1**. The intersection of the supply and demand curves of photosynthesis. The `Photosyn` function solves for C~i~ if g~s~, V~cmax~, J~max~ and R~d~ (and other parameters to the FvC model) are known.


```{r fig.width=6, fig.height=6, echo=FALSE, message=FALSE, eval=includeFigs, warn=FALSE}
figure2()
```
**Figure 2**. Standard output from the `fitaci` function. A~net~ is the net photosynthetic rate, C~i~ the intercellular CO~2~ concentration. Symbols are measurements, the line the fitted Farquhar model of photosynthesis.



# References {.unnumbered}

